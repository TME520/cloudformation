{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This template deploys a full instance of Protocol/7 (EC2, R53, Jenkins, p7, cb1).",
  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Default": "ec2key",
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
    },
    "InstanceType": {
      "Description": "WebServer EC2 instance type",
      "Type": "String",
      "Default": "t2.micro",
      "AllowedValues": [
        "t2.micro"
      ],
      "ConstraintDescription": "must be a valid EC2 instance type."
    },
    "AuthorizedIp": {
      "Description": "The IP address range that can be used to SSH to the EC2 instances.",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "0.0.0.0/0",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "HostedZoneName": {
      "Description": "The route53 HostedZoneName. Don't forget the period at the end.",
      "Type": "String",
      "Default": ""
    },
    "P7InstanceName": {
      "Description": "Name for this instance of Protocol/7",
      "Type": "String",
      "Default": "p7"
    },
    "P7InstanceClient": {
      "Description": "Name of the client being monitored by this instance of Protocol/7.",
      "Type": "String",
      "Default": "pantzumatic"
    },
    "P7InstanceEnv": {
      "Description": "Name of the environment being monitored by this instance of Protocol/7 (dev, test, uat, integ, prod...)",
      "Type": "String",
      "Default": "test"
    },
    "P7InstanceProject": {
      "Description": "Name of the project this instance of Protocol/7 is monitoring.",
      "Type": "String",
      "Default": "mkultra"
    },
    "StackName": {
      "Description": "Name given to the stack",
      "Type": "String",
      "Default": ""
    },
    "SlackToken": {
      "Description": "The Slack token that will be used to interact with Slack.",
      "Type": "String",
      "Default": ""
    },
    "AzureStorageAccountName": {
      "Description": "The Microsoft Azure storage account that will be used to store the dashboard HTML files.",
      "Type": "String",
      "Default": ""
    },
    "AzureStorageAccountKey": {
      "Description": "The key for the Microsoft Azure storage account.",
      "Type": "String",
      "Default": ""
    },
    "AzureDevopsUrl": {
      "Description": "The URL from which your Microsoft DevOps account can be accessed.",
      "Type": "String",
      "Default": ""
    },
    "AzureDevopsPat": {
      "Description": "The Personal Access Token that will be used to interact with Azure DevOps (in order to retrieve latest deployments for example).",
      "Type": "String",
      "Default": ""
    },
    "NtApiUser": {
      "Description": "N/A",
      "Type": "String",
      "Default": ""
    },
    "NtApiPassword": {
      "Description": "N/A",
      "Type": "String",
      "Default": ""
    },
    "NtApiSearchUrl": {
      "Description": "N/A",
      "Type": "String",
      "Default": ""
    },
    "NtApiLoginUrl": {
      "Description": "N/A",
      "Type": "String",
      "Default": ""
    },
    "SumoEndpoint": {
      "Description": "The HTTPS endpoint used to send logs to Sumologic.",
      "Type": "String",
      "Default": ""
    },
    "DynamodbUrl": {
      "Description": "The URL used to interact with DynamoDB. The stack includes a local instance of DynamoDB that you should use unless you really know what you do. DO NOT APPEND http:// IN FRONT OF THE URL.",
      "Type": "String",
      "Default": ""
    },
    "ChatbotoneDataFolder": {
      "Description": "The folder used by Chat Bot One to write its data.",
      "Type": "String",
      "Default": ""
    },
    "DashboardFilename": {
      "Description": "The HTML file generated by Protocol/7 to be used as a dashboard (simple mode).",
      "Type": "String",
      "Default": ""
    },
    "AdvancedDashboardFilename": {
      "Description": "The HTML file generated by Protocol/7 to be used as a dashboard (advanced mode).",
      "Type": "String",
      "Default": ""
    },
    "DashboardBaseUrl": {
      "Description": "The URL pointing to the HTML dashboard files.",
      "Type": "String",
      "Default": ""
    },
    "LogsFolder": {
      "Description": "The location of Protocol/7's logs.",
      "Type": "String",
      "Default": ""
    },
    "LogFilename": {
      "Description": "The main log file for Protocol/7.",
      "Type": "String",
      "Default": ""
    },
    "ConfigFilename": {
      "Description": "The config file for Protocol/7.",
      "Type": "String",
      "Default": ""
    },
    "EnableBlinkstick": {
      "Description": "Enable Blinkstick usage (not recommended unless you run Protocol/7 locally).",
      "Type": "String",
      "Default": ""
    },
    "EnableSlack": {
      "Description": "Let Protocol/7 write messages to Slack.",
      "Type": "String",
      "Default": ""
    },
    "EnableSumologic": {
      "Description": "Let Protocol/7 send its log to Sumologic.",
      "Type": "String",
      "Default": ""
    },
    "EnableDashboard": {
      "Description": "Let Protocol/7 generate a dashboard (2 HTML files hosted somewhere).",
      "Type": "String",
      "Default": ""
    },
    "StoreDashAzure": {
      "Description": "Tell Protocol/7 to store its dashboard on an Azure Blob Storage instance.",
      "Type": "String",
      "Default": ""
    },
    "StoreDashAWS": {
      "Description": "Tell Protocol/7 to store its dashboard on a AWS S3 bucket.",
      "Type": "String",
      "Default": ""
    },
    "S3BucketName": {
      "Description": "Name of the S3 bucket hosting the dashboard.",
      "Type": "String",
      "Default": ""
    },
    "AWSSecretKeyID": {
      "Description": "AWS secret access key ID.",
      "Type": "String",
      "Default": ""
    },
    "AWSSecretAccessKey": {
      "Description": "AWS secret access key.",
      "Type": "String",
      "Default": ""
    },
    "AWSRegion": {
      "Description": "AWS region in which the stack will be created.",
      "Type": "String",
      "Default": ""
    }
  },
  "Mappings": {
    "AWSInstanceType2Arch": {
      "t2.micro": {
        "Arch": "HVM64"
      }
    },
    "AWSInstanceType2NATArch": {
      "t2.micro": {
        "Arch": "NATHVM64"
      }
    },
    "AWSRegionArch2AMI": {
      "ap-southeast-2": {
        "PV64": "ami-63351d00",
        "HVM64": "ami-dc361ebf",
        "HVMG2": "ami-0ad2db69"
      }
    },
    "TrueOrFalseIndexMap": {
      "false": {
        "state": "0"
      },
      "true": {
        "state": "1"
      }
    }
  },
  "Resources": {
    "EC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "SecurityGroups": [
          {
            "Ref": "InstanceSecurityGroup"
          }
        ],
        "KeyName": {
          "Ref": "KeyName"
        },
        "ImageId": {
          "Fn::FindInMap": [
            "AWSRegionArch2AMI",
            {
              "Ref": "AWS::Region"
            },
            {
              "Fn::FindInMap": [
                "AWSInstanceType2Arch",
                {
                  "Ref": "InstanceType"
                },
                "Arch"
              ]
            }
          ]
        },
        "Tags": [
          {
            "Key": "created-by",
            "Value": "TME520"
          },
          {
            "Key": "expiry",
            "Value": "never"
          },
          {
            "Key": "purpose",
            "Value": "This EC2 instance runs Protocol/7."
          },
          {
            "Key": "stack",
            "Value": { "Ref": "AWS::StackName" }
          }
        ],
        "UserData": {
          "Fn::Base64" : {
            "Fn::Join" : [
              "", [
                "#!/bin/bash -xe\n",
                "yum install -y aws-cfn-bootstrap\n",
                "/opt/aws/bin/cfn-init ",
                "         --stack ", { "Ref" : "AWS::StackName" },
                "         --resource EC2Instance ",
                "         --configsets FullProtocol7 ",
                "         --region ", { "Ref" : "AWS::Region" }, "\n"
              ]
            ]
          }
        }
      },
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "FullProtocol7": ["SetTZ", "AddYumRepositories","YumUpgrade","BasicSetup","JenkinsWeeklySetup","DDBInstall","DDBStart","P7Install","P7Dependencies","P7Configure","StartProtocol7","Persona7Install","Persona7Configure","StartPersona7","InstallBlinkStick"]
          },
          "SetTZ": {
            "files": {
              "/etc/sysconfig/clock": {
                "content": {
                  "Fn::Join": [
                    "", [
                      "ZONE=\"Australia/Melbourne\"\n",
                      "UTC=true"
                    ]
                  ]
                }
              }
            },
            "commands": {
              "set_timezone": {
                "command": "echo 'Setting timezone to Australia/Melbourne...' && ln -sf /usr/share/zoneinfo/Australia/Melbourne /etc/localtime"
              }
            }
          },
          "AddYumRepositories": {
            "commands": {
              "add_jenkins_repo": {
                "command": "wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat/jenkins.repo && rpm --import https://pkg.jenkins.io/redhat/jenkins.io.key && yum remove -y java-1.7.0-openjdk"
              }
            }
          },
          "YumUpgrade": {
            "commands": {
              "upgrade_yum_packages": {
                "command": "yum update -y && yum upgrade -y"
              }
            }
          },
          "BasicSetup": {
            "packages": {
              "yum": {
                "htop": [],
                "git": [],
                "python36-pip": [],
                "jenkins": [],
                "java-1.8.0-openjdk-devel": []
              }
            },
            "files": {
              "/home/ec2-user/.cfn-init-run-check": {
                "content": {
                  "Fn::Join": [
                    "", [
                      "[general]\n",
                      "Stack: ", { "Ref": "AWS::StackName" }, "\n",
                      "Region: ", { "Ref": "AWS::Region" }, "\n"
                    ]
                  ]
                },
                "mode": "000644",
                "user": "ec2-user",
                "group": "ec2-user"
              }
            }
          },
          "JenkinsWeeklySetup": {
            "commands": {
              "start_jenkins": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "echo 'Starting Jenkins...';",
                      "service jenkins start;"
                    ]
                  ]
                }
              }
            }
          },
          "DDBInstall": {
            "commands": {
              "dl_and_install_dynamodb": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "cd /home/ec2-user/ && mkdir dynamodb && cd ./dynamodb;",
                      "wget -O dynamodb_local_latest.tar.gz https://s3.ap-southeast-1.amazonaws.com/dynamodb-local-singapore/dynamodb_local_latest.tar.gz;",
                      "tar xzvf dynamodb_local_latest.tar.gz;",
                      "chown -R ec2-user:ec2-user /home/ec2-user/dynamodb/;"
                    ]
                  ]
                }
              }
            }
          },
          "DDBStart": {
            "commands": {
              "start_dynamodb": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "cd /home/ec2-user/dynamodb/;",
                      "nohup java -Djava.library.path=./DynamoDBLocal_lib -jar DynamoDBLocal.jar -port 8001 > foo.out 2> foo.err < /dev/null &"
                    ]
                  ]
                }
              }
            }
          },
          "P7Install": {
            "commands": {
              "install_protocol7": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "echo 'Installing Protocol/7...';",
                      "pip install --upgrade pip;",
                      "pip-3.6 install --user 'cozmo[camera]';",
                      "cd /home/ec2-user/;",
                      "git clone https://github.com/TME520/protocol7.git;",
                      "chown -R ec2-user:ec2-user ./protocol7/;"
                    ]
                  ]
                }
              }
            }
          },
          "P7Dependencies": {
            "commands": {
              "install_pip_modules": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "pip-3.6 install cozmo exchangelib slackclient blinkstick sklearn pandas nltk joblib argparse boto3 colorama notify2 azure-storage-blob azure-mgmt-compute azure-mgmt-storage azure-mgmt-resource azure-keyvault-secrets azure-storage-blob requests_toolbelt requests azure-devops msrest redis;"
                    ]
                  ]
                }
              }
            }
          },
          "P7Configure": {
            "files": {
              "/tmp/.cfn-init-was-there": {
                "content": {
                  "Fn::Join": [
                    "", [
                      "[general]\n",
                      "Stack: ", { "Ref": "AWS::StackName" }, "\n",
                      "Region: ", { "Ref": "AWS::Region" }, "\n",
                      "P7 instance name: ", { "Ref": "P7InstanceName" }, "\n",
                      "P7 instance client: ", { "Ref": "P7InstanceClient" }, "\n",
                      "P7 instance environment: ", { "Ref": "P7InstanceEnv" }, "\n",
                      "P7 instance project: ", { "Ref": "P7InstanceProject" }, "\n",
                      "Authorized IP: ", { "Ref": "AuthorizedIp" }, "\n",
                      "Hosted zone name: ", { "Ref": "HostedZoneName" }, "\n",
                      "Slack token: ", { "Ref": "SlackToken" }, "\n",
                      "Azure storage account name: ", { "Ref": "AzureStorageAccountName" }, "\n",
                      "Azure storage account key: ", { "Ref": "AzureStorageAccountKey" }, "\n",
                      "Azure DevOps URL: ", { "Ref": "AzureDevopsUrl" }, "\n",
                      "Azure DevOps Personal Access Token: ", { "Ref": "AzureDevopsPat" }, "\n",
                      "NT API user: ", { "Ref": "NtApiUser" }, "\n",
                      "NT API password: ", { "Ref": "NtApiPassword" }, "\n",
                      "NT API search URL: ", { "Ref": "NtApiSearchUrl" }, "\n",
                      "NT API login URL: ", { "Ref": "NtApiLoginUrl" }, "\n",
                      "Sumologic endpoint: ", { "Ref": "SumoEndpoint" }, "\n",
                      "Dynamodb URL: ", { "Ref": "DynamodbUrl" }, "\n",
                      "Chat Bot One data folder: ", { "Ref": "ChatbotoneDataFolder" }, "\n",
                      "Dashboard filename: ", { "Ref": "DashboardFilename" }, "\n",
                      "Advanced dashboard filename: ", { "Ref": "AdvancedDashboardFilename" }, "\n",
                      "Dashboard base URL: ", { "Ref": "DashboardBaseUrl" }, "\n",
                      "Logs folder: ", { "Ref": "LogsFolder" }, "\n",
                      "Log filename: ", { "Ref": "LogFilename" }, "\n",
                      "Config filename: ", { "Ref": "ConfigFilename" }, "\n",
                      "Blinkstick enabled: ", { "Ref": "EnableBlinkstick" }, "(", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableBlinkstick" }, "state" ] }, ")","\n",
                      "Slack messages enabled: ", { "Ref": "EnableSlack" }, "(", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableSlack" }, "state" ] }, ")","\n",
                      "Send logs to Sumologic: ", { "Ref": "EnableSumologic" }, "(", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableSumologic" }, "state" ] }, ")","\n",
                      "Enable dashboard: ", { "Ref": "EnableDashboard" }, "(", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableDashboard" }, "state" ] }, ")", "\n",
                      "Store dashboard in Azure: ", { "Ref": "StoreDashAzure" }, "(", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "StoreDashAzure" }, "state" ] }, ")","\n",
                      "Store dashboard in AWS: ", { "Ref": "StoreDashAWS" }, "(", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "StoreDashAWS" }, "state" ] }, ")", "\n",
                      "AWS access key ID: ", { "Ref": "AWSSecretKeyID" }, "\n"
                    ]
                  ]
                },
                "mode": "000644",
                "user": "ec2-user",
                "group": "ec2-user"
              }
            },
            "commands": {
              "configure_protocol7": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "echo 'Configuring Protocol/7...';",
                      "cd /home/ec2-user/protocol7/;",
                      "cp -pv ./startTemplate.sh.template ./startProtocol7.sh;",
                      "chmod +x ./startProtocol7.sh;",
                      "sed -i 's/SED001/", { "Ref": "P7InstanceName"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED002/", { "Ref": "P7InstanceClient"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED003/", { "Ref": "P7InstanceEnv"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED004/", { "Ref": "P7InstanceProject"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED005/", { "Ref": "SlackToken"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED006/", { "Ref": "AzureStorageAccountName"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED007/", { "Ref": "AzureStorageAccountKey"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED008/", { "Ref": "NtApiUser"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED009/", { "Ref": "NtApiPassword"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED010/", { "Ref": "AzureDevopsPat"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's,SED011,", { "Ref": "SumoEndpoint"}, ",g' ./startProtocol7.sh;",
                      "sed -i 's,SED012,", { "Ref": "DynamodbUrl"}, ",g' ./startProtocol7.sh;",
                      "sed -i 's,SED013,", { "Ref": "ChatbotoneDataFolder"}, ",g' ./startProtocol7.sh;",
                      "sed -i 's/SED014/", { "Ref": "DashboardFilename"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED015/", { "Ref": "AdvancedDashboardFilename"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED016/", { "Ref": "DashboardBaseUrl"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED017/", { "Ref": "AzureDevopsUrl"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's,SED018,", { "Ref": "LogsFolder"}, ",g' ./startProtocol7.sh;",
                      "sed -i 's/SED019/", { "Ref": "LogFilename"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED020/", { "Ref": "ConfigFilename"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED021/", { "Ref": "NtApiSearchUrl"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED022/", { "Ref": "NtApiLoginUrl"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED023/", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableBlinkstick" }, "state" ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED024/", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableSlack" }, "state" ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED025/", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableSumologic" }, "state" ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED026/", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "EnableDashboard" }, "state" ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED030/", { "Fn::Join": [ "", [ "", { "Ref": "AWS::StackName" }, ".", { "Ref": "DashboardBaseUrl" } ] ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED031/", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "StoreDashAzure" }, "state" ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED032/", { "Fn::FindInMap" : [ "TrueOrFalseIndexMap", { "Ref": "StoreDashAWS" }, "state" ] }, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED033/", { "Ref": "AWSSecretKeyID"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED034/", { "Ref": "AWSSecretAccessKey"}, "/g' ./startProtocol7.sh;",
                      "sed -i 's/SED035/", { "Ref": "AWSRegion"}, "/g' ./startProtocol7.sh;"
                    ]
                  ]
                }
              }
            }
          },
          "StartProtocol7": {
            "commands": {
              "start_persona7": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "cd /home/ec2-user/protocol7/;",
                      "nohup ./startProtocol7.sh > foo.out 2> foo.err < /dev/null &"
                    ]
                  ]
                }
              }
            }
          },
          "Persona7Install": {
            "commands": {
              "install_persona7": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "echo 'Installing Persona/7...';",
                      "cd /home/ec2-user/;",
                      "git clone https://github.com/TME520/persona7.git;",
                      "chown -R ec2-user:ec2-user ./persona7/;"
                    ]
                  ]
                }
              }
            }
          },
          "Persona7Configure": {
            "commands": {
              "configure_persona7": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "echo 'Configuring Persona/7...';",
                      "cd /home/ec2-user/persona7/;",
                      "cp -pv ./startTemplate.sh.template ./startPersona7.sh;",
                      "chmod +x ./startPersona7.sh;",
                      "sed -i 's/SED001/", { "Ref": "SlackToken"}, "/g' ./startPersona7.sh;"
                    ]
                  ]
                }
              }
            }
          },
          "StartPersona7": {
            "commands": {
              "start_persona7": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "cd /home/ec2-user/persona7/;",
                      "nohup ./startPersona7.sh > foo.out 2> foo.err < /dev/null &"
                    ]
                  ]
                }
              }
            }
          },
          "InstallBlinkStick": {
            "commands": {
              "install_blinkstick": {
                "command": {
                  "Fn::Join": [
                    "", [
                      "cd /home/ec2-user/;",
                      "git clone https://github.com/TME520/p7devices.git;",
                      "chown -R ec2-user:ec2-user ./p7devices/;"
                    ]
                  ]
                }
              }
            }
          }
        }
      }
    },
    "InstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Enable SSH access via port 22, DynamoDB access via port 8001 and HTTP access via port 8080.",
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 22,
            "ToPort": 22,
            "CidrIp": { "Ref": "AuthorizedIp" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 8080,
            "ToPort": 8080,
            "CidrIp": { "Ref": "AuthorizedIp" }
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 8001,
            "ToPort": 8001,
            "CidrIp": { "Ref": "AuthorizedIp" }
          }
        ],
        "Tags": [
          {
            "Key" : "created-by",
            "Value" : "TME520"
          },
          {
            "Key" : "expiry",
            "Value" : "never"
          },
          {
            "Key" : "purpose",
            "Value" : "Run Protocol/7 safely."
          },
          {
            "Key": "stack",
            "Value": { "Ref": "AWS::StackName" }
          }
        ]
      }
    },
    "myDNSRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneName": { "Ref": "HostedZoneName" },
        "Comment": "DNS name for the EC2 instance running Jenkins and P7",
        "Name": { "Fn::Join": [ "", [ "", "jenkins", ".", { "Ref": "AWS::StackName" }, ".", { "Ref": "HostedZoneName" } ] ] },
        "TTL": 300,
        "Type": "CNAME",
        "ResourceRecords": [
          { "Fn::GetAtt": [ "EC2Instance", "PublicIp" ] }
        ]
      }
    },
    "myDNSRecord2": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneName": { "Ref": "HostedZoneName" },
        "Comment": "DNS name for the S3 bucket hosting P7 dashboard",
        "Name": { "Fn::Join": [ "", [ "", { "Ref": "AWS::StackName" }, ".", { "Ref": "DashboardBaseUrl" } ] ] },
        "TTL": 300,
        "Type": "CNAME",
        "ResourceRecords": [
          { "Fn::Select" : [ 1, { "Fn::Split" : [ "//",  { "Fn::GetAtt": [ "S3Bucket", "WebsiteURL" ] } ] } ] }
        ]
      }
    },
    "S3Bucket": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Delete",
      "Properties": {
        "BucketName": { "Fn::Join": [ "", [ "", { "Ref": "AWS::StackName" }, ".", { "Ref": "DashboardBaseUrl" } ] ] },
        "AccessControl": "PublicRead",
        "WebsiteConfiguration": {
          "ErrorDocument": "error.html",
          "IndexDocument": { "Ref": "DashboardFilename"}
        }
      }  
    },
    "S3BucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": { "Ref": "S3Bucket" },
        "PolicyDocument": {
          "Statement": {
            "Effect": "Allow",
            "Action": [ "s3:GetObject" ],
            "Principal": "*",
            "Resource": { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "S3Bucket" } , "/*" ]]}
          }
        }
      }
    }
  },
  "Outputs": {
    "InstanceId": {
      "Description": "InstanceId of the newly created EC2 instance",
      "Value": {
        "Ref": "EC2Instance"
      }
    },
    "AZ": {
      "Description": "Availability Zone of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "EC2Instance",
          "AvailabilityZone"
        ]
      }
    },
    "PublicDNS": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "EC2Instance",
          "PublicDnsName"
        ]
      }
    },
    "PublicIP": {
      "Description": "Public IP address of the newly created EC2 instance",
      "Value": {
        "Fn::GetAtt": [
          "EC2Instance",
          "PublicIp"
        ]
      }
    },
    "SSHConnectionShellCommand": {
      "Description": "The command line you have to type in order to SSH into the EC2 instance (path to SSH key may vary).",
      "Value": {
        "Fn::Join": [ "", [ "", "ssh -v -i $HOME/.ssh/", { "Ref": "KeyName"}, ".pem ec2-user@", { "Fn::GetAtt": [ "EC2Instance", "PublicIp" ] } ] ]
      }
    },
    "RecordSetName": {
      "Description": "The DNS entry pointing to the EC2 instance.",
      "Value": {
        "Fn::Join": [ "", [ "", { "Ref": "AWS::StackName" }, ".", { "Ref": "HostedZoneName" } ] ]
      }
    },
    "FQDNSSHConnectionShellCommand": {
      "Description": "The command line you have to type in order to SSH into the EC2 instance (path to SSH key may vary).",
      "Value": {
        "Fn::Join": [ "", [ "", "ssh -v -i $HOME/.ssh/", { "Ref": "KeyName"}, ".pem ec2-user@", { "Ref": "AWS::StackName" }, ".", { "Ref": "HostedZoneName" } ] ]
      }
    },
    "JenkinsURL": {
      "Description": "The URL you have to open in order to use Jenkins.",
      "Value": {
        "Fn::Join": [ "", [ "", "http://", "jenkins", ".", { "Ref": "AWS::StackName" }, ".", { "Ref": "HostedZoneName" }, ":8080" ] ]
      }
    },
    "DashboardURL": {
      "Description": "URL pointing to the dashboard generated and maintained by Protocol/7",
      "Value": {
        "Fn::Join": [ "", [ "", "http://", { "Ref": "AWS::StackName" }, ".", { "Ref": "HostedZoneName" } ] ]
      }
    }
  }
}
